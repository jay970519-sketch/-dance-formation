<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>éšŠå½¢æ¨¡æ“¬å™¨ - äººæ•¸ä¿®æ­£ç‰ˆ</title>
<style>
  :root { --primary: #2196f3; --success: #4caf50; --danger: #ff5252; --dark: #2c3e50; }
  html, body { overflow: hidden; position: fixed; width: 100%; height: 100%; margin: 0; padding: 0; overscroll-behavior: none; font-family: -apple-system, sans-serif; background: #1a1a1a; }
  #header { background: #fff; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 10; }
  .title { font-weight: bold; color: var(--dark); font-size: 1.1rem; }
  #canvas-container { flex-grow: 1; display: flex; justify-content: center; align-items: center; overflow: hidden; touch-action: none; background: #333; height: calc(100vh - 160px); }
  canvas { background: #fff; box-shadow: 0 0 20px rgba(0,0,0,0.5); max-width: 95%; max-height: 95%; object-fit: contain; border-radius: 4px; }
  #footer { height: 100px; background: #fff; border-top: 1px solid #ddd; display: flex; align-items: center; padding: 0 10px; overflow-x: auto; gap: 12px; z-index: 10; }
  .form-card { flex: 0 0 110px; height: 75px; background: #f0f2f5; border: 2px solid transparent; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; transition: 0.3s; cursor: pointer; }
  .form-card.active { border-color: var(--success); background: #e8f5e9; color: var(--success); font-weight: bold; }
  .form-name { font-size: 13px; margin-top: 4px; max-width: 90%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding: 2px 5px; border-radius: 4px; }
  .btn-del-mini { position: absolute; top: -8px; right: -8px; width: 24px; height: 24px; background: var(--danger); color: white; border-radius: 50%; border: none; font-size: 16px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
  .menu-btn { background: var(--primary); color: white; border: none; padding: 8px 15px; border-radius: 20px; font-size: 13px; font-weight: bold; }
  .add-btn { flex: 0 0 50px; height: 50px; background: var(--success); color: white; border: none; border-radius: 50%; font-size: 28px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
  #modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 100; }
  .modal-content { background: white; padding: 20px; border-radius: 12px; width: 85%; max-width: 400px; }
  .modal-row { margin-bottom: 15px; }
  .modal-row label { display: block; margin-bottom: 5px; font-size: 14px; color: #666; }
  .modal-row input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
  .modal-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .btn-action { padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 14px; }
</style>
</head>
<body>

<div id="header">
  <div class="title">éšŠå½¢æ¨¡æ“¬å™¨</div>
  <button class="menu-btn" onclick="toggleModal(true)">å·¥å…· âš™ï¸</button>
</div>

<div id="canvas-container">
  <canvas id="field" width="1000" height="600"></canvas>
</div>

<div id="footer">
  <button class="add-btn" onclick="newFormation()">+</button>
  <div id="list" style="display: flex; gap: 12px; align-items: center;"></div>
</div>

<div id="modal" onclick="if(event.target===this) toggleModal(false)">
  <div class="modal-content">
    <h3 style="margin-top:0">äººæ•¸è¨­å®š</h3>
    <div class="modal-row">
      <div style="display:flex; gap:10px;">
        <div style="flex:1"><label>ç¸½äººæ•¸</label><input type="number" id="totalCount" value="36"></div>
        <div style="flex:1"><label>å¥³ç”Ÿæ•¸</label><input type="number" id="femaleCount" value="18"></div>
      </div>
      <button class="btn-action" style="background:var(--success); color:white; width:100%; margin-top:10px;" onclick="applyNewCounts()">âœ… å¥—ç”¨ä¸¦é‡è¨­æ‰€æœ‰éšŠå½¢</button>
      <p style="font-size:11px; color:red; margin-top:5px;">*æ³¨æ„ï¼šå¥—ç”¨æ–°çš„äººæ•¸æœƒæ¸…ç©ºç›®å‰çš„éšŠå½¢è¨­è¨ˆï¼</p>
    </div>
    <hr>
    <div class="modal-btns">
      <button class="btn-action" style="background:var(--primary); color:white;" onclick="downloadImg()">ğŸ“¸ å­˜æˆåœ–ç‰‡</button>
      <button class="btn-action" style="background:#fb8c00; color:white;" onclick="exportToFile()">ğŸ’¾ å°å‡ºæª”æ¡ˆ</button>
      <button class="btn-action" style="background:#7e57c2; color:white;" onclick="document.getElementById('fileInput').click()">ğŸ“‚ åŒ¯å…¥æª”æ¡ˆ</button>
      <button class="btn-action" style="background:#666; color:white;" onclick="toggleModal(false)">è¿”å›</button>
    </div>
    <input type="file" id="fileInput" style="display:none" onchange="importFromFile(event)">
  </div>
</div>

<script>
const canvas = document.getElementById("field");
const ctx = canvas.getContext("2d");
const GRID = 25, R = 15;

let people = [], formations = [], currentIdx = -1, selected = [];
let dragging = null, isMoving = false, animating = false;

function getPos(e) {
  const rect = canvas.getBoundingClientRect();
  const scaleX = canvas.width / rect.width, scaleY = canvas.height / rect.height;
  const clientX = e.touches ? e.touches[0].clientX : e.clientX;
  const clientY = e.touches ? e.touches[0].clientY : e.clientY;
  return { x: (clientX - rect.left) * scaleX, y: (clientY - rect.top) * scaleY };
}

function snap(v){ return Math.round(v/GRID)*GRID; }

function drawBackground(){
  ctx.fillStyle="#e9efe9"; ctx.fillRect(0,0,1000,600);
  ctx.strokeStyle="#d8d8d8"; ctx.lineWidth = 1;
  for(let x=0; x<=1000; x+=GRID){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,600); ctx.stroke(); }
  for(let y=0; y<=600; y+=GRID){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(1000,y); ctx.stroke(); }
  ctx.setLineDash([10, 5]); ctx.strokeStyle = "rgba(255, 0, 0, 0.5)"; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.moveTo(500, 0); ctx.lineTo(500, 600); ctx.stroke();
  ctx.setLineDash([]);
  ctx.fillStyle = "#2c3e50"; ctx.fillRect(380, 530, 240, 45);
  ctx.fillStyle = "#fff"; ctx.font = "bold 18px sans-serif"; ctx.textAlign = "center";
  ctx.fillText("è£ åˆ¤ å° (æ­£é¢)", 500, 558);
}

function draw() {
  ctx.clearRect(0,0,1000,600);
  drawBackground();
  people.forEach(p=>{
    ctx.beginPath(); ctx.arc(p.x, p.y, R, 0, Math.PI*2);
    ctx.fillStyle = p.gender==="male" ? "#2b6cff" : "#e63946"; ctx.fill();
    if(selected.includes(p)){ ctx.strokeStyle="#000"; ctx.lineWidth = 3; ctx.stroke(); }
  });
}

function animateTo(targetData) {
  if (animating) return;
  animating = true;
  const startData = JSON.parse(JSON.stringify(people));
  let startTime = null;
  function step(timestamp) {
    if (!startTime) startTime = timestamp;
    const progress = Math.min((timestamp - startTime) / 400, 1);
    const ease = progress * (2 - progress);
    people.forEach((p, i) => {
      p.x = startData[i].x + (targetData[i].x - startData[i].x) * ease;
      p.y = startData[i].y + (targetData[i].y - startData[i].y) * ease;
    });
    draw();
    if (progress < 1) requestAnimationFrame(step); else animating = false;
  }
  requestAnimationFrame(step);
}

// é—œéµä¿®æ­£ï¼šå¥—ç”¨æ–°çš„äººæ•¸ä¸¦é‡è¨­
function applyNewCounts() {
  if(confirm("é€™å°‡æœƒæ¸…é™¤ç›®å‰æ‰€æœ‰å·²æ’å¥½çš„éšŠå½¢ï¼Œä¸¦ä¾ç…§æ–°çš„äººæ•¸é‡æ–°é–‹å§‹ã€‚ç¢ºå®šå—ï¼Ÿ")) {
    formations = [];
    initPeople();
    newFormation();
    saveToLocal();
    toggleModal(false);
    alert("äººæ•¸å·²æ›´æ–°ï¼");
  }
}

function initPeople() {
  const total = parseInt(document.getElementById('totalCount').value) || 1;
  const female = parseInt(document.getElementById('femaleCount').value) || 0;
  people = [];
  for(let i=0; i<total; i++) {
    people.push({ 
        id: i, 
        x: 140 + (i % 8) * 100, 
        y: 100 + Math.floor(i / 8) * 80, 
        gender: i < female ? "female" : "male" 
    });
  }
}

function switchFormation(idx) {
  if (animating || idx === currentIdx) return;
  currentIdx = idx; animateTo(formations[idx].data); updateList(); saveToLocal();
}

function renameFormation(e, idx) {
  e.stopPropagation();
  const n = prompt("è¼¸å…¥éšŠå½¢åç¨±ï¼š", formations[idx].name);
  if (n) { formations[idx].name = n; updateList(); saveToLocal(); }
}

function newFormation() {
  formations.push({ name: "éšŠå½¢ " + (formations.length + 1), data: JSON.parse(JSON.stringify(people)) });
  currentIdx = formations.length - 1; updateList(); saveToLocal();
}

function handleStart(e) {
  if (animating) return;
  const {x, y} = getPos(e);
  let hit = people.find(p => Math.hypot(p.x-x, p.y-y) < R + 15);
  if(hit){ selected = [hit]; dragging = hit; isMoving = false; } else { selected = []; }
  draw();
}

function handleMove(e) {
  if(!dragging) return;
  e.preventDefault();
  const {x, y} = getPos(e);
  const dx = snap(x) - dragging.x, dy = snap(y) - dragging.y;
  if(dx !== 0 || dy !== 0){
    isMoving = true;
    selected.forEach(p => { p.x += dx; p.y += dy; });
    formations[currentIdx].data = JSON.parse(JSON.stringify(people));
    draw();
  }
}

function handleEnd() { if(isMoving) saveToLocal(); dragging = null; }
function toggleModal(show) { document.getElementById('modal').style.display = show ? 'flex' : 'none'; }

function updateList(){
  const list = document.getElementById("list"); list.innerHTML = "";
  formations.forEach((f, idx) => {
    const card = document.createElement("div");
    card.className = `form-card ${idx===currentIdx?'active':''}`;
    card.innerHTML = `<div class="form-name" onclick="renameFormation(event, ${idx})">${f.name} âœï¸</div>
                     <button class="btn-del-mini" onclick="deleteFormation(event, ${idx})">Ã—</button>`;
    card.onclick = (e) => { if(!e.target.classList.contains('form-name')) switchFormation(idx); };
    list.appendChild(card);
  });
}

function saveToLocal() { localStorage.setItem('dance_v6', JSON.stringify({ total: document.getElementById('totalCount').value, female: document.getElementById('femaleCount').value, forms: formations, currentIdx })); }

function loadSession() {
  const local = localStorage.getItem('dance_v6');
  if (local) {
    const d = JSON.parse(local);
    document.getElementById('totalCount').value = d.total;
    document.getElementById('femaleCount').value = d.female;
    formations = d.forms; currentIdx = d.currentIdx || 0;
    people = JSON.parse(JSON.stringify(formations[currentIdx].data));
  } else { initPeople(); newFormation(); }
  updateList(); draw();
}

function deleteFormation(e, idx) { e.stopPropagation(); if(formations.length<=1) return; formations.splice(idx,1); currentIdx=0; people=JSON.parse(JSON.stringify(formations[0].data)); updateList(); draw(); saveToLocal(); }
function downloadImg() { selected=[]; draw(); const a=document.createElement('a'); a.download='éšŠå½¢.png'; a.href=canvas.toDataURL(); a.click(); }
function exportToFile() { const blob=new Blob([JSON.stringify({total:document.getElementById('totalCount').value, female:document.getElementById('femaleCount').value, forms:formations})], {type:"application/json"}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='éšŠå½¢å­˜æª”.json'; a.click(); }
function importFromFile(e) { const reader=new FileReader(); reader.onload=ev=>{ const d=JSON.parse(ev.target.result); formations=d.forms; currentIdx=0; people=JSON.parse(JSON.stringify(formations[0].data)); saveToLocal(); updateList(); draw(); toggleModal(false); }; reader.readAsText(e.target.files[0]); }

canvas.addEventListener('touchstart', handleStart, {passive: false});
window.addEventListener('touchmove', handleMove, {passive: false});
window.addEventListener('touchend', handleEnd);
canvas.addEventListener('mousedown', handleStart);
window.addEventListener('mousemove', handleMove);
window.addEventListener('mouseup', handleEnd);
window.onload = loadSession;
</script>
</body>
</html>